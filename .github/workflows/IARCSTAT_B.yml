name: IARCSTAT_B

on:
  push:
    branches:
      - MS70_M3351
  workflow_dispatch:
  # When a previous run of this workflow completes, GitHub will emit workflow_run
  workflow_run:
    workflows: ["IARCSTAT_A"]
    types:
      - completed

# env å¯ä¿ç•™ä½ åŽŸæœ¬çš„ secret
env:
  IAR_LMS_BEARER_TOKEN: ${{ secrets.IAR_LMS_BEARER_TOKEN }}

jobs:
  cstat-project:
    name: Static Code Analysis (Checkpoint Enabled & Auto-Resume)
    runs-on: ubuntu-latest
    container: ghcr.io/iarsystems/arm:9.70.1-base

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore progress (if any)
        uses: actions/download-artifact@v4
        with:
          name: cstat-progress
          path: progress
        continue-on-error: true

      - name: Determine start index
        id: load_progress
        run: |
          TOTAL_EWPS=$(find ./SampleCode -name '*.ewp' | wc -l | tr -d ' ')
          if [[ -f progress/progress.json ]]; then
            start=$(jq -r '.index' progress/progress.json)
            if [[ "$start" == "null" || -z "$start" ]]; then
              start=0
            fi
            echo "Found checkpoint. start_index=$start"
          else
            start=0
            echo "No checkpoint found. start_index=0"
          fi
          echo "total_ewps=$TOTAL_EWPS" >> $GITHUB_OUTPUT
          echo "start_index=$start" >> $GITHUB_OUTPUT

      - name: Exit if already complete
        if: ${{ steps.load_progress.outputs.start_index != '' }}
        run: |
          start=${{ steps.load_progress.outputs.start_index }}
          total=${{ steps.load_progress.outputs.total_ewps }}
          if [[ -z "$total" ]]; then
            echo "0" > /tmp/total
            total=0
          fi
          echo "start=$start total=$total"
          if [[ "$start" -ge "$total" ]]; then
            echo "All projects already processed (start >= total). Exiting."
            # create a marker artifact so logs show final state
            echo "{\"index\": $start, \"status\": \"complete\"}" > progress.json
            exit 0
          fi

      - name: Static Analysis with checkpointing
        shell: bash
        run: |
          set -euo pipefail
          MISSUDAD_IAR="$GITHUB_WORKSPACE/.github/MissUDad/IAR"
          MISSUDAD_IAR_EWT="$MISSUDAD_IAR/c-stat.ewt"

          # gather solutions into an array (sorted to keep deterministic order)
          mapfile -t solutions < <(find ./SampleCode -name '*.ewp' | sort)

          total=${{ steps.load_progress.outputs.total_ewps }}
          start=${{ steps.load_progress.outputs.start_index }}
          if [[ -z "$start" ]]; then start=0; fi
          echo "Found ${#solutions[@]} solutions, starting at index $start"

          # Safety: stop earlier than 6 hours to avoid GitHub kill
          MAX_SECONDS=$((5 * 3600))   # run at most 5 hours per job
          START_TIME=$(date +%s)

          processed=0
          set +e
          for (( i=start; i<${#solutions[@]}; i++ )); do
            now=$(date +%s)
            elapsed=$((now - START_TIME))
            if (( elapsed >= MAX_SECONDS )); then
              echo "â³ Time limit reached after ${elapsed}s at index $i. Saving checkpoint and exiting job."
              echo "{\"index\": $i}" > progress.json
              break
            fi

            sol_path="${solutions[$i]}"
            dir=$(dirname "$sol_path")
            sol_name=$(basename "$sol_path")
            sol_base="${sol_name%.*}"
            ewt_path="$dir/$sol_base.ewt"
            log_path="$dir/$sol_name.cstat.log"

            echo "â–¶ ($i) Analyzing: $sol_path"

            # prepare .ewt
            cp -f "$MISSUDAD_IAR_EWT" "$ewt_path"

            # run analysis (tolerate errors per-project)
            iarbuild "$sol_path" -cstat_analyze '*' -log all > "$log_path" 2>&1
            ret1=$?
            iarbuild "$sol_path" -cstat_report '*' -log all >> "$log_path" 2>&1
            ret2=$?

            if [[ $ret1 -ne 0 || $ret2 -ne 0 ]]; then
              echo "âŒ Analysis failed for $sol_path (ret1=$ret1 ret2=$ret2). Log appended: $log_path"
            else
              echo "âœ… Analysis success for $sol_path"
            fi

            # update checkpoint to next index
            next_index=$((i+1))
            echo "{\"index\": $next_index}" > progress.json
            # upload/reporting of per-project log can be done after loop
            processed=$((processed+1))
          done
          set -e

          # if loop finished all solutions, write completion marker
          if (( ${#solutions[@]} > 0 )); then
            last_index=$(jq -r '.index' progress.json 2>/dev/null || echo "0")
            if [[ "$last_index" == "null" || -z "$last_index" ]]; then last_index=0; fi
            if (( last_index >= ${#solutions[@]} )); then
              echo "ðŸŽ‰ All projects processed. last_index=$last_index total=${#solutions[@]}"
              echo "{\"index\": $last_index, \"status\": \"complete\"}" > progress.json
            fi
          fi

      - name: Save progress artifact
        uses: actions/upload-artifact@v4
        with:
          name: cstat-progress
          path: progress.json

      - name: Upload C-STAT HTML reports (if any)
        uses: actions/upload-artifact@v4
        with:
          name: IAR-C-STAT-Analysis-Report-${{ github.run_id }}
          path: SampleCode/**/C-STAT/*.html
          if-no-files-found: warn

      - name: Upload per-project logs (optional)
        uses: actions/upload-artifact@v4
        with:
          name: IAR-C-STAT-Logs-${{ github.run_id }}
          path: SampleCode/**/*.cstat.log
          if-no-files-found: warn
