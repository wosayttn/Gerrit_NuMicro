name: IAR_CSTAT

on:
  #push:
  #  branches-ignore:
  #    - main
  #    - master
  workflow_dispatch:

# Set a new GitHub Actions Secret named IAR_LMS_BEARER_TOKEN
# for your repository. The secret is then propagated to an
# Environment variable used for all jobs within this workflow
env:
  IAR_LMS_BEARER_TOKEN: ${{ secrets.IAR_LMS_BEARER_TOKEN }}

jobs:
  cstat-project:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 350   # ‚è±Ô∏è Global 5.8-hour timeout for the entire job    
    container: ghcr.io/iarsystems/arm:9.70.1-base
    steps:
      - uses: actions/checkout@v4
      - name: Static Analysis
        shell: bash
        run: |
          MISSUDAD_IAR="$GITHUB_WORKSPACE/.github/MissUDad/IAR"
          MISSUDAD_IAR_EWT="$MISSUDAD_IAR/c-stat.ewt"
          mapfile -t solutions < <(find ./SampleCode -name '*.ewp')
          declare -a attachments=()

          set +e
          for sol_path in "${solutions[@]}"; do

            dir=$(dirname "$sol_path")
            sol_name=$(basename "$sol_path")
            sol_base_name="${sol_name%.*}"
            ewt_path="$dir/$sol_base_name.ewt"
            log_path="$dir/$sol_name.cstat.log"

            cp -f "$MISSUDAD_IAR_EWT" "$ewt_path"

            start=$(date +%s)

            iarbuild $sol_path -cstat_analyze '*' -log all > $log_path
            ret1=$?

            iarbuild $sol_path -cstat_report '*' -log all >> $log_path
            ret2=$?

            end=$(date +%s)
            elapsed=$(( end - start ))

            if [[ $ret1 -ne 0 || $ret2 -ne 0 ]]; then
              echo "‚ùå Build failed: $sol_path"
              echo "üîç Log:"
              cat "$log_path"
              attachments+=("$log_path")   #add log into the set.
            else
              echo "‚úÖ Analysis success: $sol_path"
            fi
            echo "‚è±Ô∏è Elapsed: ${elapsed}s"

          done
          set -e

      - name: Upload project report (C-STAT)
        if: always()  # ‚Üê ensures upload runs on success, failure, or timeout
        uses: actions/upload-artifact@v4
        with:
          name: IAR-CSTAT-Report-${{ github.ref_name }}
          path: SampleCode/**/C-STAT/*.html
          if-no-files-found: warn # recommended for timeouts