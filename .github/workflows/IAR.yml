name: IAR

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Build IAR projects
        shell: bash
        run: |
          MISSUDAD_IAR="$GITHUB_WORKSPACE/.github/MissUDad/IAR"

          set +e
          cd $MISSUDAD_IAR
          python build.py
          retc=$?
          if [ $retc -ne 0 ]; then
            echo "‚ùå Build Failed:"
            cat "$MISSUDAD_IAR/attachments.txt"
            cp -af "$MISSUDAD_IAR/attachments.txt" "$GITHUB_WORKSPACE/"
            exit $retc
          else
            echo "üéâ All building succeeded!" $REPO_ROOT
          fi

      - name: Send mail
        if: failure()
        uses: ./.github/actions/send-mail
        with:
          mail-connection: ${{ secrets.MAIL_CONNECTION }}
          mail-to-ms10: ${{ secrets.MAIL_TO_MS10 }}
          mail-to-ms20: ${{ secrets.MAIL_TO_MS20 }}
          mail-to-ms40: ${{ secrets.MAIL_TO_MS40 }}
          mail-to-ms70: ${{ secrets.MAIL_TO_MS70 }}
          default-mail-to: ${{ secrets.MAIL_TO }}
          workflow-name: ${{ github.workflow }}
          ref-name: ${{ github.ref_name }}

      - name: Collect artifacts with directory structure
        shell: bash
        run: |
          mkdir -p artifacts
          find SampleCode -type f -name "*.bin" -exec cp --parents {} artifacts/ \;

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-artifacts
          path: artifacts/
