# USB Host Secure ISP Sample Code

> **This document is automatically generated by AI and is for reference only.**  
> * Please verify the correctness of all technical details and code
> * Security-related implementations (such as encryption algorithms and key management) require thorough testing

## Description
This sample code demonstrates how to implement a Secure ISP Host using the NuMicro USB Host HID driver. It is designed to work with the `SecureISPDemo` sample code (Device side).

## Project Structure
*   `main.c`: System initialization, USB Host core initialization, and device detection loop.
*   `ProcessCommand.c`: Implements the Secure ISP protocol, including connection, ECDH key exchange, AES encryption/decryption, and command processing.
*   `user_hid_core.c`: Customized USB Host HID driver.

## Operation Flow
1.  **Initialization**: Configures system clocks and USB Host stack.
2.  **Device Detection**: Waits for a USB HID device to be connected.
3.  **Secure ISP Handshake**:
    *   **Stage 1 (Connection)**: Sends `CMD_CONNECT` to verify device presence.
    *   **Stage 2 (Key Exchange)**: Performs ECDH (Elliptic Curve Diffie-Hellman) to derive a shared secret key.
    *   **Stage 3 (Encrypted Communication)**: Enters a command loop where all data is encrypted using AES-256.
4.  **Command Menu**:
    *   `[0] Read ID`: Reads the target device's ID.
    *   `[1] Erase Flash`: Erases a specific flash region.
    *   `[2] Write Flash`: Writes data to the flash.
    *   `[3-5] Vendor Function`: Executes custom vendor commands.
    *   `[90] Reset Device`: Resets the target device.

## Implementation Notes
*   **USB Communication**: Uses HID Interrupt In/Out endpoints.
*   **Security**:
    *   **ECDH**: Uses Curve P-256 for key exchange.
    *   **AES-256**: Uses CFB mode for packet encryption.
    *   **Integrity**: Uses Checksum/CRC to validate packets.
*   **Blocking Wait**: The current implementation uses a busy loop to wait for device responses. For production use, a timeout mechanism is recommended.

## Test Output
![Test Output](test_output.png)