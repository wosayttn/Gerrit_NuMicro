# Secure ISP Implementation Analysis and Command Description

This document describes the operation flow, security mechanisms, and supported command set of Secure ISP.

> **This document is automatically generated by AI and is for reference only.**  
> * Please verify the correctness of all technical details and code
> * Security-related implementations (such as encryption algorithms and key management) require thorough testing

## 1. Secure ISP Flow Analysis

The execution flow of Secure ISP is mainly divided into three stages:

1.  **Connection Stage (Stage 1)**:
    *   Host sends `CMD_CONNECT` (0x80) command.
    *   Device responds and confirms the connection.
    *   This stage is not encrypted and is mainly used to confirm if the device is online.

2.  **Key Exchange Stage (Stage 2)**:
    *   Uses **ECDH (Elliptic Curve Diffie-Hellman)** algorithm for key exchange.
    *   Both parties exchange Public Keys (`CMD_ECDH_PUB0`, `CMD_ECDH_PUB1`, etc.).
    *   Host and Device independently calculate the **Shared Key**.
    *   This stage ensures that the encryption key for subsequent communication is known only to the Host and Device, and the key itself is never transmitted over the network.

3.  **Encrypted Communication Stage (Stage 3)**:
    *   All subsequent commands (e.g., `CMD_WRITE`, `CMD_ERASE`) are transmitted using **AES-256** encryption.
    *   The packet structure includes IV (Initialization Vector), encrypted payload, and Checksum.
    *   Upon receiving the packet, the Device decrypts it, executes the command, and encrypts the response before sending it back.

## 2. Communication Handshake and Encryption Mechanism

*   **Handshake**:
    *   Via ECDH protocol (Curve P-256), both parties exchange public keys.
    *   Host generates a random private key and public key, and sends the public key to the Device.
    *   Device generates a random private key and public key, and sends the public key to the Host.
    *   Both parties use the other's public key and their own private key to calculate the same Shared Secret.
*   **Encryption**:
    *   Uses **AES-256** algorithm.
    *   Operation mode is **CFB (Cipher Feedback)** mode, suitable for stream encryption.
*   **Integrity**:
    *   Packets include Checksum or CRC verification to ensure data has not been tampered with during transmission.

## 3. Role of Initialization Vector (IV)

*   **Purpose**:
    *   IV is used for randomization in AES-CFB encryption mode.
    *   It ensures that even if the same plaintext is transmitted, the ciphertext will be different each time, preventing pattern analysis.
*   **Security**:
    *   IV **does not need to be secret** and can be transmitted in plaintext.
    *   The security of the communication relies entirely on the secrecy of the Shared Key.
*   **Update Mechanism**:
    *   The system supports `CMD_GET_RAND_IV` and `CMD_SET_RAND_IV` commands.
    *   IV can be updated for each new communication session or specific operation to prevent Replay Attacks.

## 4. Supported Command List

The following tables summarize the Secure ISP commands defined in `CommandHandler.h` and implemented in `CommandHandler.c`.

### 1. Connection & Handshake Stage (Stage 1 & 2)

| Command ID | Name | Description | Parameters/Remarks |
| :--- | :--- | :--- | :--- |
| `0x80` | `CMD_CONNECT` | Establish Connection | Returns Device ID (PDID) and Initialization Vector (IV). |
| `0x8E` | `CMD_DISCONNECT` | Disconnect | Ends the current ISP Session. |
| `0x8000` | `CMD_RESYNC` | Resync | Resets connection state, clears all Keys and IVs. |
| `0x8600` | `CMD_ECDH_PUB0` | Receive Server Public Key (Part 0) | Receives the first half of the PC-side ECC public key. |
| `0x8601` | `CMD_ECDH_PUB1` | Receive Server Public Key (Part 1) | Receives the second half and triggers generation of the 1st ECDH shared key. |
| `0x8602` | `CMD_ECDH_GET_PUB0` | Read Client Public Key (Part 0) | Returns the first half of the Device-side ECC public key (Encrypted). |
| `0x8603` | `CMD_ECDH_GET_PUB1` | Read Client Public Key (Part 1) | Returns the second half of the Device-side ECC public key (Encrypted). |
| `0x8604` | `CMD_ECDH_RAND_PUB0` | Receive Random Server Public Key (Part 0) | Receives the first half of the PC-side temporary random public key (Encrypted). |
| `0x8605` | `CMD_ECDH_RAND_PUB1` | Receive Random Server Public Key (Part 1) | Receives the second half (Encrypted). |
| `0x8606` | `CMD_ECDH_GET_RAND_PUB0` | Read Random Client Public Key (Part 0) | Generates and returns the first half of the Device temporary random public key (Encrypted). |
| `0x8607` | `CMD_ECDH_GET_RAND_PUB1` | Read Random Client Public Key (Part 1) | Returns the second half and switches to the 2nd ECDH shared key (Encrypted). |

### 2. General Operation Commands (Stage 3)

| Command ID | Name | Description | Parameters/Remarks |
| :--- | :--- | :--- | :--- |
| `0x81` | `CMD_RESET` | System Reset | `0`: Chip Reset, `1`: System Reset, `2`: CPU Reset. |
| `0x82` | `CMD_READ_CONFIG` | Read Configuration | Reads User Configuration (CFG0, CFG3, etc.) and XOM status. |
| `0x83` | `CMD_WRITE` | Write Flash | Writes Flash data to the specified address. |
| `0x84` | `CMD_ERASE` | Erase Flash | Erases Flash at the specified address and page count. |
| `0x85` | `CMD_GET_ID` | Read ID Info | Reads PDID, UID, UCID, CID. |
| `0x8F` | `CMD_GET_VERSION` | Read Version | Reads Secure ISP Library version (`LIB_VERSION`). |
| `0x8300` | `CMD_SET_MASS_WRITE` | Set Mass Write | Sets the start address and total length for mass write. |
| `0x8301` | `CMD_MASS_WRITE` | Execute Mass Write | Continuously writes data packets (Max 48 bytes/packet). |
| `0x8F00` | `CMD_EXEC_VENDOR_FUNC` | Execute Vendor Function | Calls `Exec_VendorFunction` to handle custom commands (e.g., `0x1000`, `0x2000`). |

### 3. Advanced Security & Special Commands (Stage 3)

| Command ID | Name | Description | Parameters/Remarks |
| :--- | :--- | :--- | :--- |
| `0x8608` | `CMD_GET_RAND_IV` | Get Random IV | Requests Device to generate and return a new random IV. |
| `0x8609` | `CMD_SET_RAND_IV` | Set Random IV | Sets a new IV for subsequent encryption. |
| `0x8700` | `CMD_IDENTIFY_SERVER` | Server Authentication | (No specific implementation details found in code, likely reserved for extension). |
| `0x8888` | `CMD_IS_MASKED` | Check Mask Status | Used to report that certain operations are forbidden by security mask. |

### 4. Response Status Codes

| Status ID | Name | Description |
| :--- | :--- | :--- |
| `0x00` | `STS_OK` | Operation successful. |
| `0x7F` | `ERR_CMD_CONNECT` | Connection error. |
| `0x7E` | `ERR_CMD_INVALID` | Invalid Command ID. |
| `0x7D` | `ERR_CMD_CHECKSUM` | Packet Checksum (CRC32/CCITT) error. |
| `0x7B` | `ERR_ISP_WRITE` | Flash write failed (Verify error). |
| `0x7A` | `ERR_INVALID_ADDRESS` | Invalid memory address (Not 4-byte aligned or length error). |
| `0x79` | `ERR_OVER_RANGE` | Access range exceeds APROM/LDROM boundaries. |
| `0x78` | `ERR_PAGE_ALIGN` | Erase operation address not aligned to Page boundary. |
| `0x77` | `ERR_ISP_ERASE` | Flash erase failed. |
| `0x72` | `ERR_CMD_KEY_EXCHANGE` | Key exchange process error. |
| `0x6F` | `ERR_TIMEOUT` | Operation timeout. |

## Test Output
![Test Output](test_output.png)