# Secure OTA Update Guide

## Installation

### Server Side

1. Install `BSP\Tool\OTAServerDemo_v2.2.1.apk` on an Android device.
2. Copy signed firmware images `NuBL32` and `NuBL33` to the Android device.
3. Copy `NuBL2\FwKey\OTA_License.txt` to the Android device.  
    `OTA_License.txt` is used for initial Secure OTA communication handshaking and contains the public keys copied from the `NuBL2\FwKey\OTA_ECC-P256_pub.c` public key file.

    ```c
    // Example to find public key 0 and key 1 from the public key file generated by `imgtool.exe`.

    OTA_ECC-P256_pub.c:
    const unsigned char ecdsa_pub_key[] = {
         0x30, 0x59, 0x30, 0x13, 0x06, 0x07, 0x2a, 0x86,
         0x48, 0xce, 0x3d, 0x02, 0x01, 0x06, 0x08, 0x2a,
         0x86, 0x48, 0xce, 0x3d, 0x03, 0x01, 0x07, 0x03,
         0x42, 0x00, 0x04, 
         /* Start of public key 0 */ 
         0x16, 0x1d, 0xfe, 0xdd, 0xa8, 0x2f, 0x38, 0x22, 
         0x3f, 0x6c, 0x12, 0x37, 0x07, 0x78, 0x88, 0x8b, 
         0x07, 0x12, 0x64, 0x49, 0x23, 0xaa, 0x95, 0xf3, 
         0x18, 0x17, 0x3b, 0xd1, 0xb0, 0x18, 0x8b, 0x60, 
         /* Start of public key 1 */ 
         0x03, 0x58, 0x09, 0xa2, 0xf5, 0x64, 0x4b, 0x6e, 
         0xe9, 0xb6, 0x8d, 0x2c, 0x19, 0xc0, 0xab, 0x60, 
         0xeb, 0x81, 0x01, 0x20, 0x3d, 0x90, 0xdc, 0x7f, 
         0x8b, 0x96, 0xf9, 0x28, 0xa2, 0x0c, 0x66, 0xce,
    };
    ```

### Client Side (e.g. M55M1 NuMaker Board with ESP-12F Wi-Fi module)

1. Secure OTA keys for initial Secure OTA communication handshaking are copied to `gc_strOTA_PrivKey`, `gc_strOTA_PubKey0`, and `gc_strOTA_PubKey1` in `NuBL2\main.c`.
2. Build `NuBL2` and download it to your target board.

    `NuBL2` has two configurations:
    - **DirectBoot**: Used for program debugging without writing the Secure Boot Keys on the target board. This is because the Secure Boot Keys are stored in the KeyStore OTP region and can only be updated three times.
    - **SecureBoot**: Used for final production, and Secure Boot Keys must be written to KeyStore OTP correctly to boot with Secure Boot Flow.  
      Note: Users can write Secure Boot Key with Nuvoton ICP Programming Tool.

## Generate Signed Firmware Image

Users can modify and build their own `NuBL32` and `NuBL33` to generate signed firmware images.  
Each firmware has its own private key placed in the `NuBL32\FwKey` and `NuBL33\FwKey` folders.  
This sample uses the same key for `NuBL32` and `NuBL33`.

Copy the public key to `gc_strNuBL3x_PubKey0` and `gc_strNuBL3x_PubKey1` in `VerifyNuBL3x.c`.

```c
// Example to find public key 0 and key 1 from the public key file generated by `imgtool.exe`.

FwKey\ECC-P256_pub.c:
const unsigned char ecdsa_pub_key[] = { 
     0x30, 0x59, 0x30, 0x13, 0x06, 0x07, 0x2a, 0x86, 
     0x48, 0xce, 0x3d, 0x02, 0x01, 0x06, 0x08, 0x2a, 
     0x86, 0x48, 0xce, 0x3d, 0x03, 0x01, 0x07, 0x03, 
     0x42, 0x00, 0x04, 
     /* Start of public key 0 */ 
     0x18, 0xab, 0x87, 0x17, 0xff, 0xe2, 0xbb, 0x25, 
     0x45, 0x23, 0x81, 0x76, 0xbc, 0x3b, 0xd4, 0x3d, 
     0x49, 0xfa, 0x03, 0x67, 0x59, 0x97, 0x99, 0x94, 
     0xa4, 0xea, 0xcb, 0xfe, 0x7b, 0xe1, 0xc6, 0x20, 
     /* Start of public key 1 */ 
     0x72, 0x4c, 0xb7, 0x36, 0x09, 0xd0, 0x10, 0x6a, 
     0x32, 0x5b, 0x57, 0x00, 0x16, 0x31, 0x0f, 0x9b, 
     0x10, 0xc9, 0x73, 0x8b, 0x5c, 0xe4, 0x89, 0xa0, 
     0xef, 0xac, 0x88, 0xf2, 0x06, 0x2d, 0x58, 0xda, 
};
```

## Network Configuration

Target board and Android OTA server must connect to the same network.

### Android Device

Connect to a network, get its IP address, and assign this address to `OTA_SRV_IP` in `NuBL2\OTA\ota_transfer.h`.

### Target Board

Specify `WIFINAME` and `WIFIPASS` in `NuBL2\OTA\ota_transfer.h` or set `INPUT_WIFI_PROMPT` to 1 to input this information from the UART console.

## OTA Server User Guide

1. Follow `OTA_Update_APP.png` to select `NuBL32` and `NuBL33` firmware images and specify their download address.  
Download address must be the same as `NUBL32_FW_BASE` and `NUBL33_FW_BASE` specified in `NuBL2\NuBL2.h`. NuBL32 and NuBL33 also need to specify these addresses in their linker script correctly.

2. Click the "OTA PROCESS STARTED" button to start the OTA server.